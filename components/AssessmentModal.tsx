import React, { useState, useEffect, useRef } from 'react';
import { X, Loader2, Sparkles, Copy, Share2, Check } from 'lucide-react';
import { GoogleGenAI } from '@google/genai';
import { AssessmentReport } from '../types';

interface AssessmentModalProps {
  onClose: () => void;
}

export const AssessmentModal: React.FC<AssessmentModalProps> = ({ onClose }) => {
  const [step, setStep] = useState<'form' | 'loading' | 'result'>('form');
  const [formData, setFormData] = useState({
    grade: '8å¹´çº§',
    rank: 'ä¸­ç­‰ (å‰40%-60%)',
    issues: ''
  });
  const [currentReportId, setCurrentReportId] = useState<string | null>(null);
  const [reportHtml, setReportHtml] = useState('');
  const [copied, setCopied] = useState(false);
  const scrollRef = useRef<HTMLDivElement>(null);

  // Auto-scroll to top when step changes
  useEffect(() => {
    if (scrollRef.current) {
      scrollRef.current.scrollTop = 0;
    }
  }, [step]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setStep('loading');

    try {
      const apiKey = process.env.API_KEY;
      if (!apiKey) {
        throw new Error('API Key not found');
      }

      const ai = new GoogleGenAI({ apiKey });
      
      const prompt = `
        ä½ æ˜¯ä¸€ä½å¹½é»˜ã€é£è¶£ä¸”æå…·é¼“åŠ±æ€§çš„é¡¶çº§â€œå­¦ä¹ æˆ˜é˜Ÿæ•™ç»ƒâ€ã€‚ä½ çš„æ²Ÿé€šå¯¹è±¡æ˜¯åˆä¸­ç”Ÿã€‚
        è¯·ä¸è¦ä½¿ç”¨æ¯ç‡¥çš„è¯´æ•™è¯­æ°”ï¼Œè¦åƒä¸€ä¸ªå¾ˆé…·çš„å­¦é•¿æˆ–è€…æ¸¸æˆæ•™ç»ƒä¸€æ ·è¯´è¯ã€‚
        
        å­¦ç”Ÿæ¡£æ¡ˆ:
        - å¹´çº§: ${formData.grade}
        - æ®µä½: ${formData.rank}
        - é‡åˆ°çš„BOSS(å›°æ‰°): ${formData.issues}

        è¯·å®Œæˆä»¥ä¸‹ä»»åŠ¡:
        1. **åˆ¤å®šæˆ˜åŠ›å±‚çº§**:
           - åŸºç¡€åŒº (Base Zone): éœ€è¦è¡¥ä¹ æƒ¯å’ŒåŸºç¡€æ¦‚å¿µã€‚
           - æå‡åŒº (Improvement Zone): éœ€è¦æ”»å…‹å¼±ç§‘å’Œè§£é¢˜æ¨¡å‹ã€‚
           - å·…å³°åŒº (Peak Zone): éœ€è¦æ”»å…‹å‹è½´é¢˜å’Œå¿ƒæ€ã€‚
        2. **åˆ¶å®šä½œæˆ˜è®¡åˆ’**: ç»™å‡º3æ¡å…·ä½“çš„ã€ç¬¦åˆè„‘ç§‘å­¦çš„å»ºè®®ã€‚æ¯æ¡å»ºè®®éƒ½è¦åŒ…å«â€œä¸ºä»€ä¹ˆè¿™æ ·åšæœ‰æ•ˆâ€ã€‚
        
        è¯·ç›´æ¥è¾“å‡ºä¸€æ®µ HTML ä»£ç  (ä¸è¦åŒ…å« \`\`\`html æ ‡è®°ï¼Œä¸è¦ markdown)ï¼Œç»“æ„å¦‚ä¸‹:
        
        <div class="space-y-4">
          <h3 class="text-2xl font-bold text-brand-700">æˆ˜åŠ›è¯„ä¼°: [å±‚çº§åç§°] ğŸš€</h3>
          <p class="text-slate-600 bg-slate-50 p-4 rounded-xl">[ç”¨é¼“åŠ±çš„è¯­æ°”ç®€çŸ­åˆ†æç°çŠ¶ï¼Œä¾‹å¦‚ï¼šå¬èµ·æ¥ä½ é‡åˆ°äº†ç“¶é¢ˆï¼Œä½†å…¶å®åªè¦è°ƒæ•´ä¸€ä¸‹...]</p>
          
          <h4 class="text-xl font-bold text-slate-800 mt-6">ä¸“å±é€šå…³æ”»ç•¥:</h4>
          <ul class="space-y-4">
             <li class="bg-white border border-slate-200 p-4 rounded-xl shadow-sm">
                <strong class="text-lg text-brand-600 block mb-1">ğŸ® æ”»ç•¥ 1: [å»ºè®®æ ‡é¢˜]</strong>
                <span class="text-slate-700">[å»ºè®®å†…å®¹ï¼Œç®€å•æ˜“æ‡‚]</span>
             </li>
             <li class="bg-white border border-slate-200 p-4 rounded-xl shadow-sm">
                <strong class="text-lg text-brand-600 block mb-1">ğŸ›¡ï¸ æ”»ç•¥ 2: [å»ºè®®æ ‡é¢˜]</strong>
                <span class="text-slate-700">[å»ºè®®å†…å®¹]</span>
             </li>
             <li class="bg-white border border-slate-200 p-4 rounded-xl shadow-sm">
                <strong class="text-lg text-brand-600 block mb-1">âš¡ æ”»ç•¥ 3: [å»ºè®®æ ‡é¢˜]</strong>
                <span class="text-slate-700">[å»ºè®®å†…å®¹]</span>
             </li>
          </ul>
          <p class="text-sm text-slate-400 mt-4 text-center">è®°ä½ï¼šè¿™åªæ˜¯å½“ä¸‹çš„çŠ¶æ€ï¼Œä½ çš„æ½œåŠ›æ˜¯æ— é™çš„ï¼ä¿æŒè¡ŒåŠ¨ï¼âœ¨</p>
        </div>
      `;

      const response = await ai.models.generateContent({
        model: 'gemini-2.5-flash',
        contents: prompt,
      });

      const text = response.text || '<p>æŠ±æ­‰ï¼ŒæœåŠ¡å™¨æ‰çº¿äº†ï¼Œè¯·ç¨åé‡è¯•ã€‚</p>';
      const cleanHtml = text.replace(/```html|```/g, '').trim();

      // Create Report Object
      const newReport: AssessmentReport = {
        id: Date.now().toString(),
        timestamp: Date.now(),
        grade: formData.grade,
        rank: formData.rank,
        issues: formData.issues,
        contentHtml: cleanHtml
      };

      // Save to localStorage list
      const existingReports: AssessmentReport[] = JSON.parse(localStorage.getItem('jhop_reports') || '[]');
      const updatedReports = [newReport, ...existingReports];
      localStorage.setItem('jhop_reports', JSON.stringify(updatedReports));

      setReportHtml(cleanHtml);
      setCurrentReportId(newReport.id);
      setStep('result');

    } catch (error) {
      console.error(error);
      setReportHtml('<p class="text-red-500">è¿æ¥ AI æ•™ç»ƒå¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Key é…ç½®ã€‚</p>');
      setStep('result');
    }
  };

  const getPlainText = () => {
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = reportHtml;
    // Basic formatting for better readability when pasted
    return `ã€JHOP å­¦ä¹ æˆ˜åŠ›è¯„ä¼°ã€‘\n\n${tempDiv.innerText}\n\nGenerated by JHOP System`;
  };

  const handleCopy = async () => {
    const text = getPlainText();
    try {
      await navigator.clipboard.writeText(text);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    } catch (err) {
      console.error('Failed to copy', err);
    }
  };

  const handleShare = async () => {
    const text = getPlainText();
    if (navigator.share) {
      try {
        await navigator.share({
          title: 'JHOP å­¦ä¹ è¯Šæ–­æŠ¥å‘Š',
          text: text,
        });
      } catch (err) {
        // User cancelled or share failed, do nothing specific
      }
    } else {
      // Fallback for browsers that don't support Web Share API
      handleCopy();
      alert('æ‚¨çš„æµè§ˆå™¨æš‚ä¸æ”¯æŒç›´æ¥åˆ†äº«ï¼ŒæŠ¥å‘Šå·²è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚');
    }
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in">
      <div className="bg-white rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
        
        {/* Header */}
        <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-brand-50">
          <h2 className="text-lg font-bold text-brand-800 flex items-center gap-2">
            <Sparkles className="w-5 h-5" />
            AI æˆ˜é˜Ÿæ•™ç»ƒè¯Šæ–­
          </h2>
          <button onClick={onClose} className="p-2 hover:bg-white rounded-full transition-colors text-slate-500">
            <X className="w-5 h-5" />
          </button>
        </div>

        {/* Content */}
        <div ref={scrollRef} className="p-6 overflow-y-auto scroll-smooth">
          {step === 'form' && (
            <form onSubmit={handleSubmit} className="space-y-6">
              <div>
                <label className="block text-sm font-medium text-slate-700 mb-2">ä½ çš„å¹´çº§</label>
                <select 
                  className="w-full p-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-brand-500 outline-none"
                  value={formData.grade}
                  onChange={e => setFormData({...formData, grade: e.target.value})}
                >
                  <option>7å¹´çº§ (åˆä¸€)</option>
                  <option>8å¹´çº§ (åˆäºŒ)</option>
                  <option>9å¹´çº§ (åˆä¸‰)</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-slate-700 mb-2">å½“å‰æ’ä½ / çŠ¶æ€</label>
                <select 
                  className="w-full p-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-brand-500 outline-none"
                  value={formData.rank}
                  onChange={e => setFormData({...formData, rank: e.target.value})}
                >
                  <option>æ–°æ‰‹/åŸºç¡€è–„å¼± (å30%)</option>
                  <option>è¿›é˜¶/ä¸­ç­‰æ°´å¹³ (å‰40%-60%)</option>
                  <option>é«˜æ‰‹/ä¸­ä¸Šæ¸¸ (å‰10%-30%)</option>
                  <option>å¤§ç¥/é¡¶å°– (å‰5%)</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-slate-700 mb-2">æœ€å¤§çš„ BOSS (å­¦ä¹ å›°æ‰°) æ˜¯ä»€ä¹ˆï¼Ÿ</label>
                <textarea 
                  className="w-full p-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-brand-500 outline-none h-32 resize-none"
                  placeholder="æ¯”å¦‚ï¼šå•è¯èƒŒäº†å°±å¿˜ã€æ•°å­¦è®¡ç®—è€å‡ºé”™ã€ä¸€è€ƒè¯•å°±æ‰‹æŠ–..."
                  value={formData.issues}
                  onChange={e => setFormData({...formData, issues: e.target.value})}
                  required
                />
              </div>

              <div className="bg-blue-50 p-4 rounded-xl text-sm text-blue-700">
                <p>AI æ•™ç»ƒå°†ä¸ºä½ ç”Ÿæˆä¸“å±çš„â€œé€šå…³æ”»ç•¥â€ï¼Œå¹¶è‡ªåŠ¨å½’æ¡£åˆ°ä½ çš„å¤ç›˜ç®±ã€‚</p>
              </div>

              <button 
                type="submit"
                className="w-full py-4 bg-brand-600 text-white font-bold rounded-xl hover:bg-brand-700 transition-colors shadow-lg shadow-brand-200"
              >
                ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š
              </button>
            </form>
          )}

          {step === 'loading' && (
            <div className="flex flex-col items-center justify-center py-12 space-y-4">
              <Loader2 className="w-12 h-12 text-brand-500 animate-spin" />
              <p className="text-slate-600 font-medium animate-pulse">æ­£åœ¨åˆ†ææˆ˜åŠ›æ•°æ®...</p>
            </div>
          )}

          {step === 'result' && (
            <div className="space-y-6">
              <div 
                className="prose prose-brand max-w-none"
                dangerouslySetInnerHTML={{ __html: reportHtml }}
              />
              
              <div className="flex flex-col sm:flex-row gap-3 pt-4 border-t border-slate-100">
                <button 
                  onClick={handleCopy}
                  className="flex-1 flex items-center justify-center gap-2 py-3 bg-white border border-slate-200 text-slate-700 font-medium rounded-xl hover:bg-slate-50 transition-colors"
                >
                  {copied ? <Check className="w-4 h-4 text-green-500" /> : <Copy className="w-4 h-4" />}
                  {copied ? 'å·²å¤åˆ¶' : 'å¤åˆ¶å…¨æ–‡'}
                </button>
                <button 
                  onClick={handleShare}
                  className="flex-1 flex items-center justify-center gap-2 py-3 bg-white border border-slate-200 text-slate-700 font-medium rounded-xl hover:bg-slate-50 transition-colors"
                >
                  <Share2 className="w-4 h-4" />
                  åˆ†äº«æŠ¥å‘Š
                </button>
              </div>

              <button 
                onClick={onClose}
                className="w-full py-3 bg-brand-600 text-white font-bold rounded-xl hover:bg-brand-700 transition-colors shadow-md"
              >
                ä¿å­˜å¹¶å½’é˜Ÿ
              </button>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};